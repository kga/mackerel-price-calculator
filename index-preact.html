<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mackerel料金シミュレーター (Preact版)</title>
  <style>
    /* CSS Variables - Mackerel Official Brand Colors */

    :root {
      --accent-color: #1dc7fa;
      --accent-color-hover: #19C6fa;
      --accent-color-light: #0cb3e6;
      --mackerel-bg: #f8f9fa;
      --mackerel-bg-alt: #f3f4f5;
      --text-primary: #111;
      --text-secondary: #444;
      --text-tertiary: #777;
      --border-color: #b1b3b6;
      --border-color-light: #d1d3d6;
      --white: #fff;
      --error-color: #ff2635;
    }

    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino weightFixed', 'Segoe UI', 'Meiryo', sans-serif;
      background-color: var(--white);
      color: var(--text-primary);
      line-height: 1.8;
      margin: 0;
      padding: 0;
      font-size: 16px;
    }

    /* Container & Layout */
    .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    header {
      margin: 0;
      padding: 1rem 1rem;
      background: var(--accent-color);
      color: var(--white);
      text-shadow: 0 1px 0 #0b8cb3;
    }

    header h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .subtitle {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-top: 0.25rem;
    }

    main {
      display: grid;
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* Form Section */
    .calculator-form {
      background: var(--white);
      padding: 2.5rem;
      border: 1px solid var(--border-color-light);
      border-radius: 8px;
    }

    .calculator-form h2 {
      font-size: 1.5rem;
      color: var(--text-primary);
      margin-bottom: 2rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--mackerel-bg-alt);
      font-weight: 700;
    }

    .form-grid {
      display: grid;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .form-group input {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      font-size: 0.875rem;
      transition: all 0.15s ease;
      background-color: var(--white);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-group input:hover {
      border-color: var(--border-color);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(29, 199, 250, 0.08);
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-top: 0.5rem;
      line-height: 1.6;
    }

    /* Price Breakdown Section */
    .price-breakdown {
      background: var(--white);
      padding: 2.5rem;
      border: 1px solid var(--border-color-light);
      border-radius: 8px;
    }

    .price-breakdown h2 {
      font-size: 1.5rem;
      color: var(--text-primary);
      margin-bottom: 2rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--mackerel-bg-alt);
      font-weight: 700;
    }

    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
    }

    .breakdown-table td {
      padding: 1rem 0;
      border-bottom: 1px solid var(--mackerel-bg-alt);
      font-size: 1rem;
    }

    .breakdown-table td:first-child {
      color: var(--text-secondary);
    }

    .breakdown-table td:last-child {
      text-align: right;
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1.125rem;
    }

    .breakdown-note {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      padding-left: 0;
      margin-top: 0.25rem;
    }

    .breakdown-divider {
      border-bottom: 2px solid var(--border-color-light) !important;
    }

    .breakdown-subtotal {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--text-primary) !important;
    }

    .breakdown-minimum {
      color: var(--accent-color);
      font-style: italic;
    }

    .breakdown-tax {
      color: var(--text-tertiary);
    }

    .breakdown-total {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-color);
    }

    .breakdown-total td {
      padding: 1.5rem 0 0.5rem 0;
      border-bottom: none !important;
    }

    /* Footer */
    footer {
      text-align: center;
      margin: 0;
      padding: 3rem 1rem;
      font-size: 0.875rem;
      color: var(--text-tertiary);
      line-height: 1.8;
    }

    footer a {
      color: var(--accent-color);
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    footer a:hover {
      opacity: 0.7;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
      body {
        font-size: 16px;
      }

      header {
        padding: 1rem 2rem;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .subtitle {
        font-size: 0.8rem;
      }

      .form-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
      }

      main {
        grid-template-columns: 1fr 1fr;
        gap: 2.5rem;
        padding: 2.5rem 2rem;
      }
    }

    @media (max-width: 767px) {
      body {
        font-size: 14px;
      }

      header {
        padding: 1rem;
      }

      header h1 {
        font-size: 1.125rem;
      }

      .subtitle {
        font-size: 0.7rem;
      }

      main {
        padding: 1.5rem 1rem;
      }

      .calculator-form,
      .price-breakdown {
        padding: 1.5rem;
      }

      .calculator-form h2,
      .price-breakdown h2 {
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .breakdown-table td {
        padding: 0.75rem 0;
      }

      .breakdown-total {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.19.3';
    import { useState, useMemo } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';

    const html = htm.bind(h);

    // Constants
    const PRICES = {
      STANDARD_HOST: 1982,
      MICRO_HOST: 600,
      CUSTOM_METRIC: 10,
      EXTERNAL_20: 1982,
      TRACE_1M: 300,
      MINIMUM_CHARGE: 1982,
      TAX_RATE: 0.10
    };

    const INCLUDED = {
      STANDARD_METRICS: 200,
      MICRO_METRICS: 30,
      FREE_EXTERNAL: 20,
      FREE_TRACE: 5
    };

    // Utility function
    function formatPrice(price) {
      return '¥' + Math.round(price).toLocaleString('ja-JP');
    }

    // Pure calculation function
    function calculatePrice(inputs) {
      const { standardHosts, microHosts, customMetrics, externalChecks, traceSpans } = inputs;

      // Calculate host charges
      const hostCharge = (standardHosts * PRICES.STANDARD_HOST) +
                         (microHosts * PRICES.MICRO_HOST);

      // Calculate included metrics
      const includedMetrics = (standardHosts * INCLUDED.STANDARD_METRICS) +
                              (microHosts * INCLUDED.MICRO_METRICS);

      // Calculate billable custom metrics
      const billableMetrics = Math.max(0, customMetrics - includedMetrics);
      const metricCharge = billableMetrics * PRICES.CUSTOM_METRIC;

      // Calculate external monitoring charges
      const billableExternalChecks = Math.max(0, externalChecks - INCLUDED.FREE_EXTERNAL);
      const externalUnits = Math.ceil(billableExternalChecks / 20);
      const externalCharge = externalUnits * PRICES.EXTERNAL_20;

      // Calculate trace span charges
      const billableTraceSpans = Math.max(0, traceSpans - INCLUDED.FREE_TRACE);
      const traceCharge = Math.ceil(billableTraceSpans) * PRICES.TRACE_1M;

      // Calculate subtotal (tax-excluded)
      const subtotal = hostCharge + metricCharge + externalCharge + traceCharge;

      // Apply minimum charge
      const minimumApplied = subtotal < PRICES.MINIMUM_CHARGE;
      const totalExcludingTax = Math.max(subtotal, PRICES.MINIMUM_CHARGE);

      // Calculate tax and total (tax-included)
      const tax = Math.round(totalExcludingTax * PRICES.TAX_RATE);
      const totalIncludingTax = totalExcludingTax + tax;

      return {
        standardHosts,
        microHosts,
        customMetrics,
        externalChecks,
        traceSpans,
        standardCharge: standardHosts * PRICES.STANDARD_HOST,
        microCharge: microHosts * PRICES.MICRO_HOST,
        metricCharge,
        externalCharge,
        traceCharge,
        includedMetrics,
        billableMetrics,
        billableExternalChecks,
        billableTraceSpans,
        subtotal,
        minimumApplied,
        totalExcludingTax,
        tax,
        totalIncludingTax
      };
    }

    // Main App component
    function App() {
      // State for input values
      const [standardHosts, setStandardHosts] = useState(0);
      const [microHosts, setMicroHosts] = useState(0);
      const [customMetrics, setCustomMetrics] = useState(0);
      const [externalChecks, setExternalChecks] = useState(0);
      const [traceSpans, setTraceSpans] = useState(0);

      // Memoized calculation
      const calc = useMemo(() => {
        return calculatePrice({
          standardHosts,
          microHosts,
          customMetrics,
          externalChecks,
          traceSpans
        });
      }, [standardHosts, microHosts, customMetrics, externalChecks, traceSpans]);

      return html`
        <div class="container">
          <header>
            <h1>Mackerel料金シミュレーター (Preact版)</h1>
            <p class="subtitle">料金は税抜き表示です（最終的に税込み金額も表示されます）</p>
          </header>

          <main>
            <section class="calculator-form">
              <h2>利用状況を入力</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label>スタンダードホスト数</label>
                  <input
                    type="number"
                    min="0"
                    value=${standardHosts}
                    onInput=${e => setStandardHosts(+e.target.value || 0)}
                    aria-describedby="standard-hint"
                  />
                  <small id="standard-hint" class="form-hint">1台あたり¥1,982/月（税抜）<br/>200メトリック含む</small>
                </div>

                <div class="form-group">
                  <label>マイクロホスト数</label>
                  <input
                    type="number"
                    min="0"
                    value=${microHosts}
                    onInput=${e => setMicroHosts(+e.target.value || 0)}
                    aria-describedby="micro-hint"
                  />
                  <small id="micro-hint" class="form-hint">1台あたり¥600/月（税抜）<br/>30メトリック含む</small>
                </div>

                <div class="form-group">
                  <label>メトリック数</label>
                  <input
                    type="number"
                    min="0"
                    value=${customMetrics}
                    onInput=${e => setCustomMetrics(+e.target.value || 0)}
                    aria-describedby="metrics-hint"
                  />
                  <small id="metrics-hint" class="form-hint">1個あたり¥10/月（税抜）<br/>ホストに含まれる分を超えた場合のみ課金</small>
                </div>

                <div class="form-group">
                  <label>外形監視チェック数</label>
                  <input
                    type="number"
                    min="0"
                    value=${externalChecks}
                    onInput=${e => setExternalChecks(+e.target.value || 0)}
                    aria-describedby="external-hint"
                  />
                  <small id="external-hint" class="form-hint">20件まで無料<br/>以降20件ごとに¥1,982（税抜）</small>
                </div>

                <div class="form-group">
                  <label>トレーススパン数（M単位）</label>
                  <input
                    type="number"
                    min="0"
                    step="0.1"
                    value=${traceSpans}
                    onInput=${e => setTraceSpans(+e.target.value || 0)}
                    aria-describedby="trace-hint"
                  />
                  <small id="trace-hint" class="form-hint">5Mスパンまで無料<br/>以降1Mスパンごとに¥300（税抜）</small>
                </div>
              </div>
            </section>

            <section class="price-breakdown">
              <h2>料金内訳</h2>
              <table class="breakdown-table">
                <tbody>
                  <tr>
                    <td>スタンダードホスト <span>(${calc.standardHosts}台)</span></td>
                    <td>${formatPrice(calc.standardCharge)}</td>
                  </tr>
                  <tr>
                    <td>マイクロホスト <span>(${calc.microHosts}台)</span></td>
                    <td>${formatPrice(calc.microCharge)}</td>
                  </tr>
                  <tr>
                    <td>
                      メトリック <span>(${calc.customMetrics}個)</span>
                      <div class="breakdown-note">※含まれるメトリック: ${calc.includedMetrics}個</div>
                    </td>
                    <td>${formatPrice(calc.metricCharge)}</td>
                  </tr>
                  <tr>
                    <td>
                      外形監視 <span>(${calc.externalChecks}チェック)</span>
                      <div class="breakdown-note">※無料枠: 20チェック、課金対象: ${calc.billableExternalChecks}チェック</div>
                    </td>
                    <td>${formatPrice(calc.externalCharge)}</td>
                  </tr>
                  <tr>
                    <td>
                      トレーススパン <span>(${calc.traceSpans}M)</span>
                      <div class="breakdown-note">※無料枠: 5M、課金対象: ${calc.billableTraceSpans.toFixed(1)}M</div>
                    </td>
                    <td>${formatPrice(calc.traceCharge)}</td>
                  </tr>
                  <tr class="breakdown-divider">
                    <td class="breakdown-subtotal">小計（税抜）</td>
                    <td class="breakdown-subtotal">${formatPrice(calc.subtotal)}</td>
                  </tr>
                  ${calc.minimumApplied && html`
                    <tr>
                      <td class="breakdown-minimum">最低月額料金適用</td>
                      <td class="breakdown-minimum">¥1,982</td>
                    </tr>
                  `}
                  <tr>
                    <td class="breakdown-tax">消費税 (10%)</td>
                    <td class="breakdown-tax">${formatPrice(calc.tax)}</td>
                  </tr>
                  <tr class="breakdown-divider">
                    <td></td>
                    <td></td>
                  </tr>
                  <tr class="breakdown-total">
                    <td>合計（税込）</td>
                    <td>${formatPrice(calc.totalIncludingTax)}</td>
                  </tr>
                </tbody>
              </table>
            </section>
          </main>

          <footer>
            <p>※この計算機は非公式ツールです。</p>
            <p>正確な料金は<a href="https://ja.mackerel.io/pricing" target="_blank" rel="noopener noreferrer">Mackerel公式サイト</a>をご確認ください。</p>
          </footer>
        </div>
      `;
    }

    // Render the app
    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
