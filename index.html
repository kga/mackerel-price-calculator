<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mackerel料金シミュレーター</title>
  <style>
    /* CSS Variables - Mackerel Official Brand Colors */
    :root {
      --accent-color: #1dc7fa;
      --accent-color-dark: #0cb3e6;
      --accent-color-dull: #0b8cb3;
      --accent-color-black: #086682;
      --accent-color-light: #64d7fa;
      --accent-color-light2: #a8ebff;
      --accent-color-hover: #e5f9ff;
      --accent-color-grayish: #b6d1db;
      --mackerel-bg: #F5F7FA;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border-color: #E0E0E0;
      --white: #FFFFFF;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--mackerel-bg);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 1rem;
    }

    /* Container & Layout */
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem 1rem;
      background: var(--accent-color-dull);
      color: var(--white);
      box-shadow: var(--shadow);
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    main {
      display: grid;
      gap: 2rem;
    }

    /* Form Section */
    .calculator-form {
      background: var(--white);
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .calculator-form h2 {
      font-size: 1.3rem;
      color: var(--accent-color-dark);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent-color-light);
    }

    .form-grid {
      display: grid;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .form-group input {
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .form-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Price Breakdown Section */
    .price-breakdown {
      background: var(--white);
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .price-breakdown h2 {
      font-size: 1.3rem;
      color: var(--accent-color-dark);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent-color-light);
    }

    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
    }

    .breakdown-table td {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .breakdown-table td:first-child {
      color: var(--text-primary);
    }

    .breakdown-table td:last-child {
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
    }

    .breakdown-note {
      font-size: 0.85rem;
      color: var(--text-secondary);
      padding-left: 1rem;
    }

    .breakdown-divider {
      border-bottom: 2px solid var(--text-primary) !important;
    }

    .breakdown-subtotal {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .breakdown-minimum {
      color: var(--accent-color-dull);
      font-style: italic;
    }

    .breakdown-tax {
      color: var(--text-secondary);
    }

    .breakdown-total {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent-color-dark);
    }

    .breakdown-total td {
      padding: 1rem 0 0.5rem 0;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 2rem;
      padding: 1.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    footer a {
      color: var(--accent-color-dark);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
      header h1 {
        font-size: 2.5rem;
      }

      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      main {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 767px) {
      body {
        padding: 0.5rem;
      }

      header {
        padding: 1.5rem 1rem;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .calculator-form,
      .price-breakdown {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mackerel料金シミュレーター</h1>
      <p class="subtitle">料金は税抜き表示です（最終的に税込み金額も表示されます）</p>
    </header>

    <main>
      <section class="calculator-form">
        <h2>利用状況を入力</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="standard-hosts">標準ホスト数</label>
            <input
              type="number"
              id="standard-hosts"
              min="0"
              value="0"
              aria-describedby="standard-hint"
            >
            <small id="standard-hint" class="form-hint">1台あたり¥1,982/月（税抜）<br>200メトリック含む</small>
          </div>

          <div class="form-group">
            <label for="micro-hosts">マイクロホスト数</label>
            <input
              type="number"
              id="micro-hosts"
              min="0"
              value="0"
              aria-describedby="micro-hint"
            >
            <small id="micro-hint" class="form-hint">1台あたり¥600/月（税抜）<br>30メトリック含む</small>
          </div>

          <div class="form-group">
            <label for="custom-metrics">カスタムメトリクス数</label>
            <input
              type="number"
              id="custom-metrics"
              min="0"
              value="0"
              aria-describedby="metrics-hint"
            >
            <small id="metrics-hint" class="form-hint">1個あたり¥10/月（税抜）<br>ホストに含まれる分を超えた場合のみ課金</small>
          </div>

          <div class="form-group">
            <label for="external-checks">外形監視チェック数</label>
            <input
              type="number"
              id="external-checks"
              min="0"
              value="0"
              aria-describedby="external-hint"
            >
            <small id="external-hint" class="form-hint">20件まで無料<br>以降20件ごとに¥1,982（税抜）</small>
          </div>

          <div class="form-group">
            <label for="trace-spans">トレーススパン数（M単位）</label>
            <input
              type="number"
              id="trace-spans"
              min="0"
              step="0.1"
              value="0"
              aria-describedby="trace-hint"
            >
            <small id="trace-hint" class="form-hint">5Mスパンまで無料<br>以降1Mスパンごとに¥300（税抜）</small>
          </div>
        </div>
      </section>

      <section class="price-breakdown">
        <h2>料金内訳</h2>
        <table class="breakdown-table">
          <tbody>
            <tr id="row-standard">
              <td>標準ホスト <span id="standard-count">(0台)</span></td>
              <td id="standard-price">¥0</td>
            </tr>
            <tr id="row-micro">
              <td>マイクロホスト <span id="micro-count">(0台)</span></td>
              <td id="micro-price">¥0</td>
            </tr>
            <tr id="row-metrics">
              <td>
                カスタムメトリクス <span id="metrics-count">(0個)</span>
                <div class="breakdown-note" id="metrics-note">※含まれるメトリクス: 0個</div>
              </td>
              <td id="metrics-price">¥0</td>
            </tr>
            <tr id="row-external">
              <td>
                外形監視 <span id="external-count">(0チェック)</span>
                <div class="breakdown-note" id="external-note">※無料枠: 20チェック、課金対象: 0チェック</div>
              </td>
              <td id="external-price">¥0</td>
            </tr>
            <tr id="row-trace">
              <td>
                トレーススパン <span id="trace-count">(0M)</span>
                <div class="breakdown-note" id="trace-note">※無料枠: 5M、課金対象: 0M</div>
              </td>
              <td id="trace-price">¥0</td>
            </tr>
            <tr class="breakdown-divider">
              <td class="breakdown-subtotal">小計（税抜）</td>
              <td class="breakdown-subtotal" id="subtotal-price">¥0</td>
            </tr>
            <tr id="row-minimum" style="display: none;">
              <td class="breakdown-minimum">最低月額料金適用</td>
              <td class="breakdown-minimum" id="minimum-price">¥1,982</td>
            </tr>
            <tr>
              <td class="breakdown-tax">消費税 (10%)</td>
              <td class="breakdown-tax" id="tax-price">¥0</td>
            </tr>
            <tr class="breakdown-divider">
              <td></td>
              <td></td>
            </tr>
            <tr class="breakdown-total">
              <td>合計（税込）</td>
              <td id="total-price">¥0</td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>

    <footer>
      <p>※この計算機は非公式ツールです。</p>
      <p>正確な料金は<a href="https://ja.mackerel.io/pricing" target="_blank" rel="noopener noreferrer">Mackerel公式サイト</a>をご確認ください。</p>
    </footer>
  </div>

  <script>
    // Constants - Base prices (tax-excluded)
    const PRICES = {
      STANDARD_HOST: 1982,      // ¥2,180 / 1.10
      MICRO_HOST: 600,          // ¥660 / 1.10
      CUSTOM_METRIC: 10,        // ¥11 / 1.10
      EXTERNAL_20: 1982,        // ¥2,180 / 1.10
      TRACE_1M: 300,            // ¥330 / 1.10
      MINIMUM_CHARGE: 1982,     // ¥2,180 / 1.10
      TAX_RATE: 0.10
    };

    const INCLUDED = {
      STANDARD_METRICS: 200,
      MICRO_METRICS: 30,
      FREE_EXTERNAL: 20,
      FREE_TRACE: 5  // 5M spans
    };

    // DOM Elements
    const inputs = {
      standardHosts: document.getElementById('standard-hosts'),
      microHosts: document.getElementById('micro-hosts'),
      customMetrics: document.getElementById('custom-metrics'),
      externalChecks: document.getElementById('external-checks'),
      traceSpans: document.getElementById('trace-spans')
    };

    // Utility Functions
    function formatPrice(price) {
      return '¥' + Math.round(price).toLocaleString('ja-JP');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Main Calculation Function
    function calculatePrice() {
      // Get input values
      const standardHosts = parseInt(inputs.standardHosts.value) || 0;
      const microHosts = parseInt(inputs.microHosts.value) || 0;
      const customMetrics = parseInt(inputs.customMetrics.value) || 0;
      const externalChecks = parseInt(inputs.externalChecks.value) || 0;
      const traceSpans = parseFloat(inputs.traceSpans.value) || 0;

      // Calculate host charges
      const hostCharge = (standardHosts * PRICES.STANDARD_HOST) +
                         (microHosts * PRICES.MICRO_HOST);

      // Calculate included metrics
      const includedMetrics = (standardHosts * INCLUDED.STANDARD_METRICS) +
                              (microHosts * INCLUDED.MICRO_METRICS);

      // Calculate billable custom metrics
      const billableMetrics = Math.max(0, customMetrics - includedMetrics);
      const metricCharge = billableMetrics * PRICES.CUSTOM_METRIC;

      // Calculate external monitoring charges
      const billableExternalChecks = Math.max(0, externalChecks - INCLUDED.FREE_EXTERNAL);
      const externalUnits = Math.ceil(billableExternalChecks / 20);
      const externalCharge = externalUnits * PRICES.EXTERNAL_20;

      // Calculate trace span charges
      const billableTraceSpans = Math.max(0, traceSpans - INCLUDED.FREE_TRACE);
      const traceCharge = billableTraceSpans * PRICES.TRACE_1M;

      // Calculate subtotal (tax-excluded)
      const subtotal = hostCharge + metricCharge + externalCharge + traceCharge;

      // Apply minimum charge
      const minimumApplied = subtotal < PRICES.MINIMUM_CHARGE;
      const totalExcludingTax = Math.max(subtotal, PRICES.MINIMUM_CHARGE);

      // Calculate tax and total (tax-included)
      const tax = Math.round(totalExcludingTax * PRICES.TAX_RATE);
      const totalIncludingTax = totalExcludingTax + tax;

      return {
        standardHosts,
        microHosts,
        customMetrics,
        externalChecks,
        traceSpans,
        standardCharge: standardHosts * PRICES.STANDARD_HOST,
        microCharge: microHosts * PRICES.MICRO_HOST,
        metricCharge,
        externalCharge,
        traceCharge,
        includedMetrics,
        billableMetrics,
        billableExternalChecks,
        billableTraceSpans,
        subtotal,
        minimumApplied,
        totalExcludingTax,
        tax,
        totalIncludingTax
      };
    }

    // Update UI with calculation results
    function updateBreakdownDisplay(result) {
      // Update standard hosts
      document.getElementById('standard-count').textContent = `(${result.standardHosts}台)`;
      document.getElementById('standard-price').textContent = formatPrice(result.standardCharge);

      // Update micro hosts
      document.getElementById('micro-count').textContent = `(${result.microHosts}台)`;
      document.getElementById('micro-price').textContent = formatPrice(result.microCharge);

      // Update custom metrics
      document.getElementById('metrics-count').textContent = `(${result.customMetrics}個)`;
      document.getElementById('metrics-price').textContent = formatPrice(result.metricCharge);
      document.getElementById('metrics-note').textContent =
        `※含まれるメトリクス: ${result.includedMetrics}個`;

      // Update external monitoring
      document.getElementById('external-count').textContent = `(${result.externalChecks}チェック)`;
      document.getElementById('external-price').textContent = formatPrice(result.externalCharge);
      document.getElementById('external-note').textContent =
        `※無料枠: ${INCLUDED.FREE_EXTERNAL}チェック、課金対象: ${result.billableExternalChecks}チェック`;

      // Update trace spans
      document.getElementById('trace-count').textContent = `(${result.traceSpans}M)`;
      document.getElementById('trace-price').textContent = formatPrice(result.traceCharge);
      document.getElementById('trace-note').textContent =
        `※無料枠: ${INCLUDED.FREE_TRACE}M、課金対象: ${result.billableTraceSpans.toFixed(1)}M`;

      // Update subtotal
      document.getElementById('subtotal-price').textContent = formatPrice(result.subtotal);

      // Show/hide minimum charge row
      const minimumRow = document.getElementById('row-minimum');
      if (result.minimumApplied) {
        minimumRow.style.display = 'table-row';
      } else {
        minimumRow.style.display = 'none';
      }

      // Update tax and total
      document.getElementById('tax-price').textContent = formatPrice(result.tax);
      document.getElementById('total-price').textContent = formatPrice(result.totalIncludingTax);
    }

    // Main update function
    function updateCalculation() {
      const result = calculatePrice();
      updateBreakdownDisplay(result);
    }

    // Initialize
    function init() {
      // Attach event listeners to all inputs
      Object.values(inputs).forEach(input => {
        input.addEventListener('input', debounce(updateCalculation, 300));
      });

      // Initial calculation
      updateCalculation();
    }

    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
