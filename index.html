<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mackerel Pricing Calculator</title>
  <style>
    /* CSS Variables - Mackerel Official Brand Colors */

    :root {
      --accent-color: #1dc7fa;
      --accent-color-hover: #19C6fa;
      --accent-color-light: #0cb3e6;
      --mackerel-bg: #f8f9fa;
      --mackerel-bg-alt: #f3f4f5;
      --text-primary: #111;
      --text-secondary: #444;
      --text-tertiary: #777;
      --border-color: #b1b3b6;
      --border-color-light: #d1d3d6;
      --white: #fff;
      --error-color: #ff2635;
    }

    /* Abbreviation Styles */
    abbr[title] {
      text-decoration: underline dotted var(--text-tertiary);
      cursor: help;
    }

    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino weightFixed', 'Segoe UI', 'Meiryo', sans-serif;
      background-color: var(--white);
      color: var(--text-primary);
      line-height: 1.8;
      margin: 0;
      padding: 0;
      font-size: 16px;
    }

    /* Container & Layout */
    .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    header {
      margin: 0;
      padding: 0;
      height: 37px;
      background: #0cb3e6;
      color: var(--white);
      text-shadow: 0 1px 0 #0b8cb3;
      display: flex;
      align-items: center;
      padding: 0 1rem;
    }

    header h1 {
      font-size: 0.875rem;
      margin: 0;
      font-weight: 500;
      letter-spacing: 0;
    }

    main {
      display: grid;
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* Form Section */
    .calculator-form {
      background: var(--white);
      padding: 2.5rem;
      border: 1px solid var(--border-color-light);
      border-radius: 8px;
    }

    .calculator-form h2 {
      font-size: 1.5rem;
      color: var(--text-primary);
      margin-bottom: 2rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--mackerel-bg-alt);
      font-weight: 700;
    }

    .form-grid {
      display: grid;
      gap: 1.5rem;
    }

    .form-section {
      grid-column: 1 / -1;
      margin-top: 1.5rem;
    }

    .form-section:first-child {
      margin-top: 0;
    }

    .form-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
      padding-left: 0.75rem;
      border-left: 4px solid var(--accent-color-light);
    }

    .form-section-grid {
      display: grid;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .form-group input {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      font-size: 0.875rem;
      transition: all 0.15s ease;
      background-color: var(--white);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-group input:hover {
      border-color: var(--border-color);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(29, 199, 250, 0.08);
    }

    .form-group input:disabled {
      background-color: var(--mackerel-bg-alt);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-top: 0.5rem;
      line-height: 1.6;
    }

    /* Details/Summary Styles */
    details.form-details {
      margin-top: 0.5rem;
      border: none;
      background-color: transparent;
    }

    details.form-details summary {
      cursor: pointer;
      padding: 0.5rem 0;
      font-weight: 600;
      color: var(--text-tertiary);
      font-size: 0.875rem;
      user-select: none;
      transition: color 0.15s ease;
    }

    details.form-details summary:hover {
      color: var(--text-secondary);
    }

    details.form-details[open] summary {
      margin-bottom: 0.75rem;
    }

    details.form-details .details-content {
      padding: 0;
      background-color: transparent;
      display: flex;
      flex-direction: column;
    }

    details.form-details .details-description {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-bottom: 0.75rem;
      line-height: 1.6;
    }

    /* Price Breakdown Section */
    .price-breakdown {
      background: var(--white);
      padding: 2.5rem;
      border: 1px solid var(--border-color-light);
      border-radius: 8px;
    }

    .price-breakdown h2 {
      font-size: 1.5rem;
      color: var(--text-primary);
      margin-bottom: 2rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--mackerel-bg-alt);
      font-weight: 700;
    }

    .breakdown-content {
      display: grid;
      gap: 1.5rem;
    }

    .breakdown-section {
      margin-top: 1.5rem;
    }

    .breakdown-section:first-child {
      margin-top: 0;
    }

    .breakdown-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
      padding-left: 0.75rem;
      border-left: 4px solid var(--accent-color-light);
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 1rem 0;
      border-bottom: 1px solid var(--mackerel-bg-alt);
    }

    .breakdown-label {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .breakdown-value {
      text-align: right;
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1.125rem;
      flex-shrink: 0;
      margin-left: 1rem;
    }

    .breakdown-note {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      padding-left: 0;
      margin-top: 0.25rem;
    }

    .breakdown-divider {
      border-bottom: 2px solid var(--border-color-light);
    }

    .breakdown-subtotal {
      font-weight: 700;
    }

    .breakdown-subtotal .breakdown-label,
    .breakdown-subtotal .breakdown-value {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 1.125rem;
    }

    .breakdown-minimum .breakdown-label,
    .breakdown-minimum .breakdown-value {
      color: var(--text-primary);
      font-style: italic;
    }

    .breakdown-tax .breakdown-label,
    .breakdown-tax .breakdown-value {
      color: var(--text-tertiary);
    }

    .breakdown-total {
      border-bottom: none;
      padding-top: 1.5rem;
      padding-bottom: 0.5rem;
    }

    .breakdown-total .breakdown-label,
    .breakdown-total .breakdown-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Footer */
    footer {
      text-align: center;
      margin: 0;
      padding: 3rem 1rem;
      font-size: 0.875rem;
      color: var(--text-tertiary);
      line-height: 1.8;
    }

    footer a {
      color: var(--accent-color);
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    footer a:hover {
      opacity: 0.7;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
      body {
        font-size: 16px;
      }

      header {
        padding: 0 2rem;
      }

      header h1 {
        font-size: 1rem;
      }

      .form-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
      }

      .form-section-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
      }

      main {
        grid-template-columns: 1fr 1fr;
        gap: 2.5rem;
        padding: 2.5rem 2rem;
      }
    }

    @media (max-width: 767px) {
      body {
        font-size: 14px;
      }

      header {
        padding: 0 1rem;
      }

      header h1 {
        font-size: 0.8125rem;
      }

      main {
        padding: 1.5rem 1rem;
      }

      .calculator-form,
      .price-breakdown {
        padding: 1.5rem;
      }

      .calculator-form h2,
      .price-breakdown h2 {
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .breakdown-table td {
        padding: 0.75rem 0;
      }

      .breakdown-total {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mackerel Pricing Calculator</h1>
    </header>

    <main>
      <section class="calculator-form">
        <h2>利用数を入力</h2>
        <div class="form-grid">
          <!-- ホストセクション -->
          <div class="form-section">
            <h3 class="form-section-title">ホスト</h3>
            <div class="form-section-grid">
              <div class="form-group">
                <label for="standard-hosts">スタンダードホスト数</label>
                <input
                  type="number"
                  id="standard-hosts"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  value="0"
                  aria-describedby="standard-hint"
                >
                <small id="standard-hint" class="form-hint">1台あたり¥1,982/月（税抜）</small>
              </div>

              <div class="form-group">
                <label for="micro-hosts">マイクロホスト数</label>
                <input
                  type="number"
                  id="micro-hosts"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  value="0"
                  aria-describedby="micro-hint"
                >
                <small id="micro-hint" class="form-hint">1台あたり¥600/月（税抜）</small>
              </div>

              <div class="form-group">
                <details class="form-details">
                  <summary>詳細設定: ホストメトリック</summary>
                  <div class="details-content">
                    <p class="details-description">無料枠を超過したホストメトリック数を入力してください（無料枠: <abbr title="スタンダードホスト">SH</abbr> 200個/台、<abbr title="マイクロホスト">MH</abbr> 30個/台）</p>
                    <label for="host-metrics">超過ホストメトリック数</label>
                    <input
                      type="number"
                      id="host-metrics"
                      min="0"
                      step="1"
                      inputmode="numeric"
                      value="0"
                      aria-describedby="host-metrics-hint"
                    >
                    <small id="host-metrics-hint" class="form-hint">1メトリックあたり¥10/月（税抜）</small>
                  </div>
                </details>
              </div>
            </div>
          </div>

          <!-- メトリック・スパンセクション -->
          <div class="form-section">
            <h3 class="form-section-title">メトリック・スパン</h3>
            <div class="form-section-grid">
              <div class="form-group">
                <label for="service-metrics">サービスメトリック数</label>
                <input
                  type="number"
                  id="service-metrics"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  value="0"
                  aria-describedby="service-metrics-hint"
                >
                <small id="service-metrics-hint" class="form-hint">1個あたり¥10/月（税抜）</small>
              </div>

              <div class="form-group">
                <label for="labeled-metrics">ラベル付きメトリック数</label>
                <input
                  type="number"
                  id="labeled-metrics"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  value="0"
                  aria-describedby="labeled-metrics-hint"
                >
                <small id="labeled-metrics-hint" class="form-hint">1個あたり¥10/月（税抜）</small>
              </div>

              <div class="form-group">
                <label for="trace-spans">トレーススパン数（100万単位）</label>
                <input
                  type="number"
                  id="trace-spans"
                  min="0"
                  step="0.1"
                  inputmode="decimal"
                  value="0"
                  aria-describedby="trace-hint"
                >
                <small id="trace-hint" class="form-hint">500万スパンまで無料<br>以降100万スパンごとに¥300（税抜）</small>
              </div>
            </div>
          </div>

          <!-- 監視セクション -->
          <div class="form-section">
            <h3 class="form-section-title">監視</h3>
            <div class="form-section-grid">
              <div class="form-group">
                <label for="external-checks">外形監視URL数</label>
                <input
                  type="number"
                  id="external-checks"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  value="0"
                  aria-describedby="external-hint"
                >
                <small id="external-hint" class="form-hint">20URLまで無料<br>以降20URLごとに<abbr title="スタンダードホスト">SH</abbr>1台換算 (¥1,982)</small>
              </div>

              <div class="form-group">
                <label for="anomaly-detection">ロール内異常検知対象ホスト数</label>
                <input
                  type="number"
                  id="anomaly-detection"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  value="0"
                  aria-describedby="anomaly-hint"
                >
                <small id="anomaly-hint" class="form-hint">5台ごとに<abbr title="スタンダードホスト">SH</abbr>1台換算 (¥1,982)</small>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="price-breakdown">
        <h2>料金内訳</h2>
        <div class="breakdown-content">
          <!-- ホストセクション -->
          <div class="breakdown-section">
            <h3 class="breakdown-section-title">ホスト</h3>
            <div class="breakdown-item" id="row-standard">
              <div class="breakdown-label">スタンダードホスト <span id="standard-count">(0台)</span></div>
              <div class="breakdown-value" id="standard-price">¥0</div>
            </div>
            <div class="breakdown-item" id="row-micro">
              <div class="breakdown-label">マイクロホスト <span id="micro-count">(0台)</span></div>
              <div class="breakdown-value" id="micro-price">¥0</div>
            </div>
          </div>

          <!-- メトリック・スパンセクション -->
          <div class="breakdown-section">
            <h3 class="breakdown-section-title">メトリック・スパン</h3>
            <div class="breakdown-item" id="row-metrics">
              <div class="breakdown-label">
                メトリック <span id="metrics-count">(0個)</span>
                <div class="breakdown-note" id="metrics-note">※含まれるメトリック: 0個</div>
              </div>
              <div class="breakdown-value" id="metrics-price">¥0</div>
            </div>
            <div class="breakdown-item" id="row-trace">
              <div class="breakdown-label">
                トレーススパン <span id="trace-count">(0百万)</span>
                <div class="breakdown-note" id="trace-note">※無料枠: 500万、課金対象: 0百万</div>
              </div>
              <div class="breakdown-value" id="trace-price">¥0</div>
            </div>
          </div>

          <!-- 監視セクション -->
          <div class="breakdown-section">
            <h3 class="breakdown-section-title">監視</h3>
            <div class="breakdown-item" id="row-external">
              <div class="breakdown-label">
                外形監視 <span id="external-count">(0URL)</span>
                <div class="breakdown-note" id="external-note">※無料枠: 20URL、課金対象: 0URL</div>
              </div>
              <div class="breakdown-value" id="external-price">¥0</div>
            </div>
            <div class="breakdown-item" id="row-anomaly">
              <div class="breakdown-label">
                ロール内異常検知 <span id="anomaly-count">(0台)</span>
                <div class="breakdown-note" id="anomaly-note">※5台ごとに<abbr title="スタンダードホスト">SH</abbr>1台換算</div>
              </div>
              <div class="breakdown-value" id="anomaly-price">¥0</div>
            </div>
          </div>

          <!-- 合計セクション -->
          <div class="breakdown-section">
            <h3 class="breakdown-section-title">合計</h3>
            <div class="breakdown-item breakdown-subtotal breakdown-divider">
              <div class="breakdown-label">小計（税抜）</div>
              <div class="breakdown-value" id="subtotal-price">¥0</div>
            </div>
            <div class="breakdown-item breakdown-minimum" id="row-minimum" style="display: none;">
              <div class="breakdown-label">最低月額料金適用</div>
              <div class="breakdown-value" id="minimum-price">¥1,982</div>
            </div>
            <div class="breakdown-item breakdown-tax">
              <div class="breakdown-label">消費税 (10%)</div>
              <div class="breakdown-value" id="tax-price">¥0</div>
            </div>
            <div class="breakdown-item breakdown-divider">
              <div class="breakdown-label"></div>
              <div class="breakdown-value"></div>
            </div>
            <div class="breakdown-item breakdown-total">
              <div class="breakdown-label">合計（税込）</div>
              <div class="breakdown-value" id="total-price">¥0</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>※このツールは非公式です。</p>
      <p>正確な料金は<a href="https://ja.mackerel.io/pricing" target="_blank" rel="noopener noreferrer">Mackerel公式サイト</a>をご確認ください。</p>
    </footer>
  </div>

  <script>
    // Constants - Base prices (tax-excluded)
    const PRICES = {
      STANDARD_HOST: 1982,      // 税抜 ¥1,982 (税込 ¥2,180)
      MICRO_HOST: 600,          // 税抜 ¥600 (税込 ¥660)
      CUSTOM_METRIC: 10,        // 税抜 ¥10 (税込 ¥11)
      TRACE_1M: 300,            // 税抜 ¥300 (税込 ¥330) per 1M spans
      MINIMUM_CHARGE: 1982,     // 税抜 ¥1,982 (税込 ¥2,180)
      TAX_RATE: 0.10
    };

    const INCLUDED = {
      STANDARD_METRICS: 200,
      MICRO_METRICS: 30,
      FREE_EXTERNAL: 20,
      FREE_TRACE: 5  // 5M spans
    };

    // DOM Elements
    const inputs = {
      standardHosts: document.getElementById('standard-hosts'),
      microHosts: document.getElementById('micro-hosts'),
      serviceMetrics: document.getElementById('service-metrics'),
      labeledMetrics: document.getElementById('labeled-metrics'),
      hostMetrics: document.getElementById('host-metrics'),
      externalChecks: document.getElementById('external-checks'),
      anomalyDetection: document.getElementById('anomaly-detection'),
      traceSpans: document.getElementById('trace-spans')
    };

    // Utility Functions
    function formatPrice(price) {
      return '¥' + Math.round(price).toLocaleString('ja-JP');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Main Calculation Function
    function calculatePrice() {
      // Get input values
      const standardHosts = parseInt(inputs.standardHosts.value) || 0;
      const microHosts = parseInt(inputs.microHosts.value) || 0;
      const serviceMetrics = parseInt(inputs.serviceMetrics.value) || 0;
      const labeledMetrics = parseInt(inputs.labeledMetrics.value) || 0;
      const hostMetrics = parseInt(inputs.hostMetrics.value) || 0;
      const externalChecks = parseInt(inputs.externalChecks.value) || 0;
      const anomalyDetection = parseInt(inputs.anomalyDetection.value) || 0;
      const traceSpans = parseFloat(inputs.traceSpans.value) || 0;

      // Calculate host charges
      const hostCharge = (standardHosts * PRICES.STANDARD_HOST) +
                         (microHosts * PRICES.MICRO_HOST);

      // Calculate service metrics charge (all billable)
      const serviceMetricCharge = serviceMetrics * PRICES.CUSTOM_METRIC;

      // Calculate labeled metrics charge (all billable)
      const labeledMetricCharge = labeledMetrics * PRICES.CUSTOM_METRIC;

      // Calculate host metrics charge (user inputs excess metrics directly)
      const excessHostMetrics = hostMetrics; // User inputs excess directly
      const hostMetricCharge = excessHostMetrics * PRICES.CUSTOM_METRIC;

      // Calculate included metrics for display reference only
      const includedMetrics = (standardHosts * INCLUDED.STANDARD_METRICS) +
                              (microHosts * INCLUDED.MICRO_METRICS);

      // Total metric charge
      const totalMetricCharge = serviceMetricCharge + labeledMetricCharge + hostMetricCharge;
      const totalMetrics = serviceMetrics + labeledMetrics + hostMetrics;

      // Calculate external monitoring charges
      // (外形監視利用数 - 20) ÷ 20 を切り上げてスタンダードホストとして換算
      const billableExternalChecks = Math.max(0, externalChecks - INCLUDED.FREE_EXTERNAL);
      const externalHostEquivalent = billableExternalChecks > 0 ? Math.ceil(billableExternalChecks / 20) : 0;
      const externalCharge = externalHostEquivalent * PRICES.STANDARD_HOST;

      // Calculate anomaly detection charges
      // ロール内異常検知対象ホスト数 ÷ 5 を切り上げてスタンダードホストとして換算
      const anomalyHostEquivalent = anomalyDetection > 0 ? Math.ceil(anomalyDetection / 5) : 0;
      const anomalyCharge = anomalyHostEquivalent * PRICES.STANDARD_HOST;

      // Calculate trace span charges
      const billableTraceSpans = Math.max(0, traceSpans - INCLUDED.FREE_TRACE);
      const traceCharge = Math.ceil(billableTraceSpans) * PRICES.TRACE_1M;

      // Calculate subtotal (tax-excluded)
      const subtotal = hostCharge + totalMetricCharge + externalCharge + anomalyCharge + traceCharge;

      // Check if there is any usage of billable features
      const hasUsage = standardHosts > 0 || microHosts > 0 || serviceMetrics > 0 ||
                       labeledMetrics > 0 || hostMetrics > 0 || externalChecks > 0 ||
                       anomalyDetection > 0 || traceSpans > 0;

      // Apply minimum charge (if there is any usage, even if subtotal is 0)
      const minimumApplied = hasUsage && subtotal < PRICES.MINIMUM_CHARGE;
      const totalExcludingTax = hasUsage ? Math.max(subtotal, PRICES.MINIMUM_CHARGE) : 0;

      // Calculate tax and total (tax-included)
      const tax = Math.round(totalExcludingTax * PRICES.TAX_RATE);
      const totalIncludingTax = totalExcludingTax + tax;

      return {
        standardHosts,
        microHosts,
        serviceMetrics,
        labeledMetrics,
        hostMetrics,
        totalMetrics,
        externalChecks,
        anomalyDetection,
        traceSpans,
        standardCharge: standardHosts * PRICES.STANDARD_HOST,
        microCharge: microHosts * PRICES.MICRO_HOST,
        serviceMetricCharge,
        labeledMetricCharge,
        hostMetricCharge,
        totalMetricCharge,
        externalCharge,
        anomalyCharge,
        traceCharge,
        includedMetrics,
        excessHostMetrics,
        billableExternalChecks,
        externalHostEquivalent,
        anomalyHostEquivalent,
        billableTraceSpans,
        subtotal,
        minimumApplied,
        totalExcludingTax,
        tax,
        totalIncludingTax
      };
    }

    // Update UI with calculation results
    function updateBreakdownDisplay(result) {
      // Update standard hosts
      document.getElementById('standard-count').textContent = `(${result.standardHosts}台)`;
      document.getElementById('standard-price').textContent = formatPrice(result.standardCharge);

      // Update micro hosts
      document.getElementById('micro-count').textContent = `(${result.microHosts}台)`;
      document.getElementById('micro-price').textContent = formatPrice(result.microCharge);

      // Update metrics (combined)
      document.getElementById('metrics-count').textContent = `(合計${result.totalMetrics}メトリック)`;
      document.getElementById('metrics-price').textContent = formatPrice(result.totalMetricCharge);
      document.getElementById('metrics-note').textContent =
        `※サービス: ${result.serviceMetrics}、` +
        `ラベル付き: ${result.labeledMetrics}、` +
        `ホスト超過分: ${result.excessHostMetrics}` +
        (result.includedMetrics > 0 ? ` (無料枠: ${result.includedMetrics})` : '');

      // Update external monitoring
      document.getElementById('external-count').textContent = `(${result.externalChecks}URL)`;
      document.getElementById('external-price').textContent = formatPrice(result.externalCharge);
      document.getElementById('external-note').innerHTML =
        `※無料枠: ${INCLUDED.FREE_EXTERNAL}、課金対象: ${result.billableExternalChecks}` +
        (result.externalHostEquivalent > 0 ? ` (<abbr title="スタンダードホスト">SH</abbr>${result.externalHostEquivalent}台換算)` : '');

      // Update anomaly detection
      document.getElementById('anomaly-count').textContent = `(${result.anomalyDetection}台)`;
      document.getElementById('anomaly-price').textContent = formatPrice(result.anomalyCharge);
      document.getElementById('anomaly-note').innerHTML =
        `※5台ごとに<abbr title="スタンダードホスト">SH</abbr>1台換算` +
        (result.anomalyHostEquivalent > 0 ? ` (<abbr title="スタンダードホスト">SH</abbr>${result.anomalyHostEquivalent}台換算)` : '');

      // Update trace spans
      document.getElementById('trace-count').textContent = `(${result.traceSpans}百万)`;
      document.getElementById('trace-price').textContent = formatPrice(result.traceCharge);
      document.getElementById('trace-note').textContent =
        `※無料枠: ${INCLUDED.FREE_TRACE * 100}万、課金対象: ${(result.billableTraceSpans * 100).toFixed(0)}万`;

      // Update subtotal
      document.getElementById('subtotal-price').textContent = formatPrice(result.subtotal);

      // Show/hide minimum charge row
      const minimumRow = document.getElementById('row-minimum');
      if (result.minimumApplied) {
        minimumRow.style.display = 'flex';
      } else {
        minimumRow.style.display = 'none';
      }

      // Update tax and total
      document.getElementById('tax-price').textContent = formatPrice(result.tax);
      document.getElementById('total-price').textContent = formatPrice(result.totalIncludingTax);
    }

    // Manage host-metrics input state based on host availability
    function updateHostMetricsInputState(result) {
      const hasHosts = result.standardHosts > 0 || result.microHosts > 0;

      if (hasHosts) {
        // Enable input when hosts exist
        inputs.hostMetrics.disabled = false;
      } else {
        // Disable input and reset value when no hosts
        inputs.hostMetrics.disabled = true;
        inputs.hostMetrics.value = '0';
      }
    }

    // Main update function
    function updateCalculation() {
      const result = calculatePrice();
      updateBreakdownDisplay(result);
      updateHostMetricsInputState(result);
    }

    // Initialize
    function init() {
      // Attach event listeners to all inputs
      Object.values(inputs).forEach(input => {
        input.addEventListener('change', updateCalculation);
      });

      // Initial calculation
      updateCalculation();
    }

    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
